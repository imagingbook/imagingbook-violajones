<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc -->
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
</head>
<body>
<main role="main">
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a id="line.1">package imagingbook.violajones.lib;</a>
<span class="sourceLineNo">002</span><a id="line.2"></a>
<span class="sourceLineNo">003</span><a id="line.3">import imagingbook.common.image.IntegralImage;</a>
<span class="sourceLineNo">004</span><a id="line.4"></a>
<span class="sourceLineNo">005</span><a id="line.5"></a>
<span class="sourceLineNo">006</span><a id="line.6">/**</a>
<span class="sourceLineNo">007</span><a id="line.7"> * Represents a Haar feature, usually composed of multiple rectangular</a>
<span class="sourceLineNo">008</span><a id="line.8"> * patches (of type {@link FeaturePatch}). Instances of this class make</a>
<span class="sourceLineNo">009</span><a id="line.9"> * the nodes of a {@link FeatureTree}.</a>
<span class="sourceLineNo">010</span><a id="line.10"> * </a>
<span class="sourceLineNo">011</span><a id="line.11"> * @author WB</a>
<span class="sourceLineNo">012</span><a id="line.12"> *</a>
<span class="sourceLineNo">013</span><a id="line.13"> */</a>
<span class="sourceLineNo">014</span><a id="line.14">public class FeatureNode {</a>
<span class="sourceLineNo">015</span><a id="line.15">        </a>
<span class="sourceLineNo">016</span><a id="line.16">        protected static final double NO_VALUE = Double.NaN;</a>
<span class="sourceLineNo">017</span><a id="line.17">        protected static final int NO_CHILD = -1;</a>
<span class="sourceLineNo">018</span><a id="line.18">        protected static final int LEFT = 0;</a>
<span class="sourceLineNo">019</span><a id="line.19">        protected static final int RIGHT = 1;</a>
<span class="sourceLineNo">020</span><a id="line.20"></a>
<span class="sourceLineNo">021</span><a id="line.21">        private final int width, height;</a>
<span class="sourceLineNo">022</span><a id="line.22">        private final double threshold;</a>
<span class="sourceLineNo">023</span><a id="line.23">        private final double[] values;  // terminal values</a>
<span class="sourceLineNo">024</span><a id="line.24">        private final int[] children;   // indexes of child nodes</a>
<span class="sourceLineNo">025</span><a id="line.25">        private final FeaturePatch[] patches;</a>
<span class="sourceLineNo">026</span><a id="line.26"></a>
<span class="sourceLineNo">027</span><a id="line.27"></a>
<span class="sourceLineNo">028</span><a id="line.28">        public FeatureNode(int width, int height, double threshold, double valL, int childL, double valR, int childR,</a>
<span class="sourceLineNo">029</span><a id="line.29">                        FeaturePatch[] patches) {</a>
<span class="sourceLineNo">030</span><a id="line.30">                this.width = width;</a>
<span class="sourceLineNo">031</span><a id="line.31">                this.height = height;</a>
<span class="sourceLineNo">032</span><a id="line.32">                this.threshold = threshold;</a>
<span class="sourceLineNo">033</span><a id="line.33">                this.values = new double[] {valL, valR};</a>
<span class="sourceLineNo">034</span><a id="line.34">                this.children = new int[] {childL, childR};</a>
<span class="sourceLineNo">035</span><a id="line.35">                this.patches = patches;</a>
<span class="sourceLineNo">036</span><a id="line.36">        }</a>
<span class="sourceLineNo">037</span><a id="line.37">        </a>
<span class="sourceLineNo">038</span><a id="line.38">        public double getValue(int dir) {</a>
<span class="sourceLineNo">039</span><a id="line.39">                return values[dir];</a>
<span class="sourceLineNo">040</span><a id="line.40">        }</a>
<span class="sourceLineNo">041</span><a id="line.41">        </a>
<span class="sourceLineNo">042</span><a id="line.42">        public boolean hasValue(int dir) {</a>
<span class="sourceLineNo">043</span><a id="line.43">                return !Double.isNaN(values[dir]);</a>
<span class="sourceLineNo">044</span><a id="line.44">        }</a>
<span class="sourceLineNo">045</span><a id="line.45">        </a>
<span class="sourceLineNo">046</span><a id="line.46">        public int getChild(int dir) {</a>
<span class="sourceLineNo">047</span><a id="line.47">                return children[dir];</a>
<span class="sourceLineNo">048</span><a id="line.48">        }</a>
<span class="sourceLineNo">049</span><a id="line.49">        </a>
<span class="sourceLineNo">050</span><a id="line.50">        public boolean hasChild(int dir) {</a>
<span class="sourceLineNo">051</span><a id="line.51">                return children[dir] != NO_CHILD;</a>
<span class="sourceLineNo">052</span><a id="line.52">        }</a>
<span class="sourceLineNo">053</span><a id="line.53">        </a>
<span class="sourceLineNo">054</span><a id="line.54">        public FeaturePatch[] getPatches() {</a>
<span class="sourceLineNo">055</span><a id="line.55">                return patches;</a>
<span class="sourceLineNo">056</span><a id="line.56">        }</a>
<span class="sourceLineNo">057</span><a id="line.57"></a>
<span class="sourceLineNo">058</span><a id="line.58">        /**</a>
<span class="sourceLineNo">059</span><a id="line.59">         * Evaluates this feature node by applying its rectangular patches.</a>
<span class="sourceLineNo">060</span><a id="line.60">         * Returns the branching direction (LEFT or RIGHT), depending on how the normalized patch </a>
<span class="sourceLineNo">061</span><a id="line.61">         * sum compares to the threshold.</a>
<span class="sourceLineNo">062</span><a id="line.62">         * @param II input image (as an integral image) </a>
<span class="sourceLineNo">063</span><a id="line.63">         * @param u left position of the candidate subimage</a>
<span class="sourceLineNo">064</span><a id="line.64">         * @param v top position of the candidate subimage</a>
<span class="sourceLineNo">065</span><a id="line.65">         * @param scale the current scale to be applied</a>
<span class="sourceLineNo">066</span><a id="line.66">         * @return The branching direction (LEFT or RIGHT).</a>
<span class="sourceLineNo">067</span><a id="line.67">         */</a>
<span class="sourceLineNo">068</span><a id="line.68">        public int eval(IntegralImage II, int u, int v, double scale) {</a>
<span class="sourceLineNo">069</span><a id="line.69">                // calculate the area of the subimage:  TODO: w,h never change, make more efficient</a>
<span class="sourceLineNo">070</span><a id="line.70">                final int w = (int) Math.round(scale * width);</a>
<span class="sourceLineNo">071</span><a id="line.71">                final int h = (int) Math.round(scale * height);</a>
<span class="sourceLineNo">072</span><a id="line.72">                </a>
<span class="sourceLineNo">073</span><a id="line.73">                // calculate variance (std. deviation) for the complete subimage: TODO: do only once for the subimage?</a>
<span class="sourceLineNo">074</span><a id="line.74">                double variance = II.getVariance(u, v, u + w - 1, v + h - 1);</a>
<span class="sourceLineNo">075</span><a id="line.75">                double stdDev = (variance &gt; 1) ? Math.sqrt(variance) : 1.0;</a>
<span class="sourceLineNo">076</span><a id="line.76"></a>
<span class="sourceLineNo">077</span><a id="line.77">                // calculate weighted sum over all patches (rectangles) of this feature</a>
<span class="sourceLineNo">078</span><a id="line.78">                double patchSum = 0.0;</a>
<span class="sourceLineNo">079</span><a id="line.79">                for (FeaturePatch patch : patches) {</a>
<span class="sourceLineNo">080</span><a id="line.80">                        // scale the patch's relative position and size</a>
<span class="sourceLineNo">081</span><a id="line.81">                        final int ua = u + (int) Math.round(scale *  patch.x);</a>
<span class="sourceLineNo">082</span><a id="line.82">                        final int va = v + (int) Math.round(scale *  patch.y);</a>
<span class="sourceLineNo">083</span><a id="line.83">                        final int ub = u + (int) Math.round(scale * (patch.x + patch.width) - 1);</a>
<span class="sourceLineNo">084</span><a id="line.84">                        final int vb = v + (int) Math.round(scale * (patch.y + patch.height) - 1);</a>
<span class="sourceLineNo">085</span><a id="line.85">                        </a>
<span class="sourceLineNo">086</span><a id="line.86">                        // add the patch's block sum and apply the assigned weight (pos/neg)</a>
<span class="sourceLineNo">087</span><a id="line.87">                        patchSum = patchSum + II.getBlockSum1(ua, va, ub, vb) * patch.weight;</a>
<span class="sourceLineNo">088</span><a id="line.88">                }</a>
<span class="sourceLineNo">089</span><a id="line.89">                // normalize the sum of all patches by the effective window area:</a>
<span class="sourceLineNo">090</span><a id="line.90">                double patchSumNorm = patchSum / (w * h);</a>
<span class="sourceLineNo">091</span><a id="line.91">                        </a>
<span class="sourceLineNo">092</span><a id="line.92">                // return direction depending on how the normalized patch sum compares to the threshold</a>
<span class="sourceLineNo">093</span><a id="line.93">                return (patchSumNorm &lt; threshold * stdDev) ? LEFT : RIGHT;</a>
<span class="sourceLineNo">094</span><a id="line.94">        }</a>
<span class="sourceLineNo">095</span><a id="line.95"></a>
<span class="sourceLineNo">096</span><a id="line.96"></a>
<span class="sourceLineNo">097</span><a id="line.97">        public void print(int featureCnt) {</a>
<span class="sourceLineNo">098</span><a id="line.98">                System.out.format("     feature %d: w=%d h=%d valL=%.4f valR=%.4f childL=%d childR=%d th=%.4f patches=%d\n", </a>
<span class="sourceLineNo">099</span><a id="line.99">                                featureCnt, width, height, getValue(LEFT), getValue(RIGHT), getChild(LEFT), getChild(RIGHT), </a>
<span class="sourceLineNo">100</span><a id="line.100">                                threshold, patches.length);</a>
<span class="sourceLineNo">101</span><a id="line.101">                int patchCnt = 0;</a>
<span class="sourceLineNo">102</span><a id="line.102">                for (FeaturePatch patch : patches) {</a>
<span class="sourceLineNo">103</span><a id="line.103">                        System.out.println("           patch " + patchCnt + " " + patch.toString());</a>
<span class="sourceLineNo">104</span><a id="line.104">                        patchCnt++;</a>
<span class="sourceLineNo">105</span><a id="line.105">                }</a>
<span class="sourceLineNo">106</span><a id="line.106">        }</a>
<span class="sourceLineNo">107</span><a id="line.107">}</a>




























































</pre>
</div>
</main>
</body>
</html>
